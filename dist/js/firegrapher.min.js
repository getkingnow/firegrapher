if("undefined"!=typeof module&&"undefined"!=typeof process)var d3=require("d3");var FireGrapher=function(){"use strict";var e=function(){function e(e){var t=["table","line","scatter","bar","map"];if("undefined"==typeof e.type)throw new Error('No graph "type" specified. Must be "table", "line", or "scatter"');if(-1===t.indexOf(e.type))throw new Error('Invalid graph "type" specified. Must be "table", "line", or "scatter"');if("undefined"==typeof e.path)throw new Error('No "path" to individual record specified.');switch(e.type){case"map":if("undefined"==typeof e.marker||"undefined"==typeof e.marker.latitude||"undefined"==typeof e.marker.longitude||"undefined"==typeof e.marker.magnitude)throw new Error('Incomplete "marker" definition specified. \nExpected: '+JSON.stringify(r().marker)+"\nActual: "+JSON.stringify(e.marker));break;case"table":if("undefined"==typeof e.columns)throw new Error('No table "columns" specified.');e.columns.forEach(function(e){if("undefined"==typeof e.label)throw new Error('Missing "columns" label.');if("undefined"==typeof e.value)throw new Error('Missing "columns" value.')});break;case"line":if("undefined"==typeof e.xCoord)throw new Error('No "xCoord" specified.');if("undefined"==typeof e.yCoord)throw new Error('No "yCoord" specified.');break;case"bar":if("undefined"==typeof e.value)throw new Error('No "value" specified.');break;case"scatter":}}function r(){var e=["#1ABC9C","#E74C3C","#9B59B6","#3498DB","#F1C40F","#D35400","#2ECC71","#E67E22","#2C3E50","#C0392B"],t=["#28E1BC","#ED7469","#B07CC6","#5FAEE3","#F4D03F","#FF6607","#54D98B","#EB9850","#3E5771","#D65448"],a={styles:{fillColor:"#DDDDDD",fillOpacity:.3,outerStrokeColor:"#000000",outerStrokeWidth:2,innerStrokeColor:"#000000",innerStrokeWidth:1,size:{width:500,height:300},axes:{x:{ticks:{fillColor:"#000000",fontSize:"14px"},label:{fillColor:"#000000",fontSize:"14px"}},y:{ticks:{fillColor:"#000000",fontSize:"14px"},label:{fillColor:"#000000",fontSize:"14px"}}},series:{strokeWidth:2,strokeColors:e,fillColors:["none","none","none","none","none","none","none","none","none","none","none"]},markers:{size:3.5,strokeWidth:2,style:"default",strokeColors:e,fillColors:t}},xCoord:{label:""},yCoord:{label:""},marker:{label:"label",latitude:"latitude",longitude:"longitude",magnitude:"radius"}};return a}function s(e,t){for(var a in t)"object"==typeof t[a]?(e[a]=e[a]?e[a]:{},s(e[a],t[a])):e[a]=e[a]?e[a]:t[a]}this.graph=function(i,n,o){e(o),s(o,r());var l=new t(i,o),d=new a(n,o,l),c=[{path:"/",params:{}}];d.parsePath(c,0),l.draw()}},t=function(t,a){function r(){var e=new google.maps.Map(d3.select(k).node(),{zoom:8,center:new google.maps.LatLng(37.76487,-122.41948),mapTypeId:google.maps.MapTypeId.TERRAIN}),t=new google.maps.OverlayView;t.onAdd=function(){function e(e){return e=new google.maps.LatLng(e.latitude,e.longitude),e=r.fromLatLngToDivPixel(e),d3.select(this).style("left",e.x-s+"px").style("top",e.y-s+"px")}var a=d3.select(t.getPanes().overlayLayer).append("div").attr("class","stations"),r=t.getProjection(),s=10;t.draw=function(){if(0!==y.length){var t=a.selectAll("svg").data(y).each(e).enter().append("svg:svg").each(e).attr("class","marker");t.append("svg:circle").attr("r",function(e){return e.radius}).attr("cx",function(e){return e.radius+s}).attr("cy",function(e){return e.radius+s}),t.append("svg:text").attr("x",s+7).attr("y",s).attr("dy",".31em").text(function(e){return e.label})}else a.selectAll("svg").remove()}},t.setMap(e)}function s(e){var t=0,a=!0;g.append("div").attr("class","row head clearfix").selectAll("div.header").data(e).enter().append("div").attr("class","header").attr("width",function(e){return e.width}).text(function(e){return e.label}).on("click",function(r){for(var s=0,i=0;i<e.length;i++)e[i]===r&&(s=i);t!==s?(t=s,a=!0):a=!a,g.selectAll("div.data").sort(function(e,r){return e[t]===r[t]?0:a?e[t]>r[t]:e[t]<r[t]})})}function i(e,t){var a=!1,r=!1;if(e&&e[0]<h.min&&(h.min=e[0],a=!0),e&&e[1]>h.max&&(h.max=e[1],a=!0),t&&t[0]<u.min&&(u.min=t[0],r=!0),t&&t[1]>u.max&&(u.max=t[1],r=!0),a&&f.domain([h.min,h.max]),r){var s=.1*(u.max-u.min);p.domain([u.min-s,u.max+s])}return a||r}function n(){var e=[];for(var t in w.graphData)"undefined"!==t&&e.push(t);if(c.selectAll("g.fg-legend").remove(),e.length>1){var a={top:5,bottom:5,left:5,right:5},r=50,s=20*e.length,i=b.styles.size.width-2*r-a.left-a.right,n=b.styles.size.height-2*s-a.top-a.bottom,o=c.append("g").attr("class","fg-legend");o.append("rect").attr("class","fg-legend-container").attr("x",i).attr("y",n).attr("width",r+a.left+a.right).attr("height",s+a.top+a.bottom).style("stroke","red").style("fill","black"),o.selectAll("text").data(e).enter().append("text").attr("class",function(e,t){return"fg-legend-series fg-series-"+t}).attr("x",i).attr("y",n).attr("dx",r).attr("dy",function(e,t){return 20*(t+1)}).style("text-anchor","end").style("stroke",function(e,t){return b.styles.series.strokeColors[t]}).text(function(e){return e})}}function o(e,t){var a=d3.svg.line().defined(function(e){return null!==e}).x(function(e){return f(e.xCoord)}).y(function(e){return p(e.yCoord)}).interpolate("linear");0===c.selectAll("path.fg-series-"+e)[0].length&&c.append("path").attr("class","fg-series fg-series-"+e),c.select("path.fg-series-"+e).data([t]).attr("class","fg-series fg-series-"+e).attr("stroke",b.styles.series.strokeColors[e]).attr("stroke-width",b.styles.series.strokeWidth).attr("fill",b.styles.series.fillColors[e]).attr("d",a(t))}function l(e,t){c.selectAll("circle.fg-series"+e).data(t).enter().append("circle").attr("class","fg-marker fg-series-"+e).attr("stroke",b.styles.markers.strokeColors[e]).attr("stroke-width",b.styles.markers.strokeWidth).attr("fill",b.styles.markers.fillColors[e]).attr("cx",function(e){return f(e.xCoord)}).attr("cy",function(e){return p(e.yCoord)}).attr("r",b.styles.markers.size)}function d(e,t){var a=t.seriesIndex;c.selectAll(".fg-bar .fg-series"+a).data([t]).enter().append("rect").attr("class","fg-series fg-series-"+a).attr("value",function(e){return e.aggregation}).attr("x",function(){return f(e)}).attr("width",f.rangeBand()).attr("y",function(e){return p(e.aggregation)}).attr("height",function(e){return p.range()[0]-p(e.aggregation)})}this.draw=function(){switch(b.type){case"map":y=[],r(),this.drawMap();break;case"table":m=[],g=d3.select(k).append("div").attr("class","table"),s(b.columns);break;case"bar":case"line":case"scatter":this.graphData={},h={min:Number.MAX_VALUE/2,max:Number.MIN_VALUE/2},u={min:Number.MAX_VALUE/2,max:Number.MIN_VALUE/2},v=0,f="bar"===b.type?d3.scale.ordinal():d3.scale.linear().domain([h.min,h.max]),f.range([0,b.styles.size.width]),p=d3.scale.linear().domain([u.min,u.max]).range([b.styles.size.height,0]),this.drawGraph()}},this.drawGraph=function(){var e={top:20,bottom:30,left:60,right:20},t=b.styles.size.height-e.bottom-e.top,a=b.styles.size.width-e.left-e.right;d3.select(k+" svg").remove(),c=d3.select(k).append("svg").attr("class","fg-"+b.type).attr("width",b.styles.size.width+e.left+e.right).attr("height",b.styles.size.height+e.bottom+e.top).append("g").attr("transform","translate("+e.left+", "+e.bottom+")"),b.title&&c.append("text").attr("class","fg-title").attr("x",a/2).attr("y",0-e.top/2).attr("text-anchor","middle").style("font-size","16px").style("text-decoration","underline").text(b.title),p.range([t,0]),"bar"===b.type?f.rangeRoundBands([0,a],.1,1):f.range([0,a]);var r=d3.svg.axis().orient("bottom").scale(f).ticks(Math.floor(.035*a)).tickSize(-t,-t),s=d3.svg.axis().orient("left").scale(p).ticks(Math.floor(.035*t)).tickSize(-a,-a);c.append("g").attr("class","fg-axis fg-x-axis").attr("transform","translate(0,"+t+")").call(r).selectAll("text").attr("x",0).attr("y",10),c.append("g").attr("class","fg-axis fg-y-axis").call(s).selectAll("text").attr("x",-10).attr("y",0),c.selectAll(".domain").attr("stroke",b.styles.outerStrokeColor).attr("stroke-width",b.styles.outerStrokeWidth).attr("fill",b.styles.fillColor).attr("fill-opacity",b.styles.fillOpacity),c.selectAll(".fg-x-axis .tick").attr("stroke",b.styles.innerStrokeColor).attr("stroke-width","bar"===b.type?0:b.styles.innerStrokeWidth),c.selectAll(".fg-y-axis .tick").attr("stroke",b.styles.innerStrokeColor).attr("stroke-width",b.styles.innerStrokeWidth),c.selectAll(".fg-x-axis text").attr("stroke","none").attr("fill",b.styles.axes.x.ticks.fillColor).attr("font-size",b.styles.axes.x.ticks.fontSize),c.selectAll(".fg-y-axis text").attr("stroke","none").attr("fill",b.styles.axes.y.ticks.fillColor).attr("font-size",b.styles.axes.y.ticks.fontSize),c.append("text").attr("class","fg-axis-label fg-x-axis-label").attr("transform","translate(0, 50)").attr("fill",b.styles.axes.x.label.fillColor).attr("font-size",b.styles.axes.x.label.fontSize).attr("font-weight","bold").attr("dx",a).attr("dy",t).style("text-anchor","end").text(b.xCoord.label),c.append("text").attr("class","fg-axis-label fg-y-axis-label").attr("transform","rotate(-90)").attr("fill",b.styles.axes.y.label.fillColor).attr("font-size",b.styles.axes.y.label.fontSize).attr("font-weight","bold").attr("dy",-e.left+16).style("text-anchor","end").text(b.yCoord.label);for(var i in w.graphData)if(w.graphData.hasOwnProperty(i)){var h=w.graphData[i].seriesIndex,u=w.graphData[i].values;switch(b.type){case"line":n(),o(h,u),l(h,u);break;case"scatter":n(),l(h,u);break;case"bar":d(i,w.graphData[i])}}},e.prototype.drawMap=function(){x.draw()},this.addDataPointToBarGraph=function(e){var t=!1;"undefined"==typeof w.graphData[e.series]&&(t=!0,v+=1,w.graphData[e.series]={seriesIndex:v,values:[],aggregation:0},f.domain(Object.keys(w.graphData))),w.graphData[e.series].values.push(e.value);var a="median",r=0;switch(a){case"mean":for(var s=0;r<w.graphData[e.series].values.length;r++)s+=w.graphData[e.series].values[r];w.graphData[e.series].aggregation=s/w.graphData[e.series].values.length;break;case"median":var n=w.graphData[e.series].values.slice(0);n.sort(function(e,t){return e-t}),w.graphData[e.series].aggregation=n[Math.ceil(n.length/2)];break;case"min":for(w.graphData[e.series].aggregation=Number.MAX_VALUE;r<w.graphData[e.series].values.length;r++)w.graphData[e.series].values[r]<w.graphData[e.series].aggregation&&(w.graphData[e.series].aggregation=w.graphData[e.series].values[r]);break;case"max":for(w.graphData[e.series].aggregation=Number.MIN_VALUE;r<w.graphData[e.series].values.length;r++)w.graphData[e.series].values[r]>w.graphData[e.series].aggregation&&(w.graphData[e.series].aggregation=w.graphData[e.series].values[r]);break;case"sum":w.graphData[e.series].aggregation+=e.value;break;default:w.graphData[e.series].aggregation+=e.value}w.graphData[e.series].aggregation=w.graphData[e.series].aggregation?w.graphData[e.series].aggregation:0,t=t||i(null,[0,w.graphData[e.series].aggregation]),t?this.drawGraph():d(e.series,w.graphData[e.series])},this.addDataPointToGraph=function(e){"undefined"==typeof w.graphData[e.series]&&(w.graphData[e.series]={seriesIndex:v,streamCount:0,values:[]},v+=1),w.graphData[e.series].streamCount+=1;var t=w.graphData[e.series].values;t.push(e),t.length>1&&e.xCoord<=t[t.length-2].xCoord&&t.sort(function(e,t){return t.xCoord-e.xCoord});var a=i(d3.extent(t,function(e){return e.xCoord}),d3.extent(t,function(e){return e.yCoord}));if(b.xCoord.limit&&t.length>b.xCoord.limit&&(t.shift(),f.domain(d3.extent(t,function(e){return e.xCoord})),a=!0),a)this.drawGraph();else{var r=w.graphData[e.series].seriesIndex;switch(n(),b.type){case"line":o(r,t),l(r,t);break;case"scatter":l(r,t)}}},this.addDataPointToMap=function(e){y.push(e),this.drawMap()},this.addDataPointToTable=function(e){m.push(e),g.selectAll("div.row").data(m).enter().append("div").attr("class","row data clearfix").selectAll("div.cell").data(function(e){return e}).enter().append("div").attr("class","cell").attr("width",function(e,t){return b.columns[t].width}).text(function(e){return e})};var c,f,p,h,u,g,m,y,x,v,b=a,k=t,w=this},a=function(e,a,r){function s(e,t){l.child(e.path).on(t,function(t){var a,r=t.val();switch(d.type){case"map":f.addDataPointToMap({path:e.path+t.name(),label:r[d.marker.label],radius:r[d.marker.magnitude],latitude:parseFloat(r[d.marker.latitude]),longitude:parseFloat(r[d.marker.longitude])});break;case"table":var s=[];d.columns.forEach(function(e){s.push("undefined"!=typeof r[e.value]?r[e.value].toString():"")}),f.addDataPointToTable(s);break;case"bar":a="$"===d.series[0]?e.params[d.series]:r[d.series],f.addDataPointToBarGraph({path:e.path+t.name(),series:a,value:parseInt(r[d.value])});break;case"line":case"scatter":a="$"===d.series[0]?e.params[d.series]:r[d.series];var i;i="undefined"!=typeof d.xCoord.stream&&d.xCoord.stream?f.graphData[a]&&f.graphData[a].streamCount?f.graphData[a].streamCount:0:parseInt(r[d.xCoord.value]),f.addDataPointToGraph({series:a,path:e.path+t.name(),xCoord:i,yCoord:parseInt(r[d.yCoord.value])})}})}function i(e){switch(d.type){case"bar":case"line":case"scatter":delete f.graphData[e],f.drawGraph()}}function n(e){switch(d.type){case"map":l.child(e.path).on("child_removed",function(t){f.mapPoints.forEach(function(a,r){a.path===e.path+t.name()&&f.mapPoints.splice(r,1)}),f.drawMap()});break;case"table":break;case"bar":case"line":case"scatter":l.child(e.path).on("child_removed",function(t){var a="$"===d.series[0]?e.params[d.series]:t.val()[d.series];f.graphData[a].values.forEach(function(r,s){if(r.path===e.path+t.name()){var i=f.graphData[a].values.splice(s,1);"bar"===d.type&&(f.graphData[a].sum-=i)}}),f.drawGraph()})}}function o(){}if(this.parsePath=function(e,t){if(t===c.length){var a="*"===c[c.length-1]?"child_added":"value";e.forEach(function(e){s(e,a),"child_added"===a&&(n(e),o(e))})}else{var r=c[t];if("*"===r[0]){if(t!==c.length-1)throw new Error('You can only use * as the last character in your "path"');this.parsePath(e,t+1)}else if("$"===r[0])e.forEach(function(e){l.child(e.path).on("child_added",function(a){var s={path:e.path+a.name()+"/",params:{}};s.params[r]=a.name();for(var i in e.params)e.params.hasOwnnKey(i)&&(s.params[i]=e.params);this.parsePath([s],t+1)}.bind(this)),l.child(e.path).on("child_removed",function(e){i(e.name())})}.bind(this));else{var d=[];e.forEach(function(e){d.push({path:e.path+r+"/",params:e.params})}),this.parsePath(d,t+1)}}},e instanceof Firebase==!1)throw new Error("firebaseRef must be an instance of Firebase");var l=e,d=a,c=d.path.split("/");if(r instanceof t==!1)throw new Error("d3Grapher must be an instance of FireGrapherD3");var f=r};return e}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=FireGrapher);