if("undefined"!=typeof module&&"undefined"!=typeof process)var d3=require("d3");var FireGrapher=function(){"use strict";var t=function(){function t(t){var e=["table","line","scatter","bar","map"];if("undefined"==typeof t.type)throw new Error('No graph "type" specified. Must be "table", "line", or "scatter"');if(-1===e.indexOf(t.type))throw new Error('Invalid graph "type" specified. Must be "table", "line", or "scatter"');if("undefined"==typeof t.path)throw new Error('No "path" to individual record specified.');switch(t.type){case"map":if("undefined"==typeof t.marker||"undefined"==typeof t.marker.latitude||"undefined"==typeof t.marker.longitude||"undefined"==typeof t.marker.magnitude)throw new Error('Incomplete "marker" definition specified. \nExpected: '+JSON.stringify(i().marker)+"\nActual: "+JSON.stringify(t.marker));break;case"table":if("undefined"==typeof t.columns)throw new Error('No table "columns" specified.');t.columns.forEach(function(t){if("undefined"==typeof t.label)throw new Error('Missing "columns" label.');if("undefined"==typeof t.value)throw new Error('Missing "columns" value.')});break;case"line":if("undefined"==typeof t.xCoord)throw new Error('No "xCoord" specified.');if("undefined"==typeof t.yCoord)throw new Error('No "yCoord" specified.');break;case"bar":if("undefined"==typeof t.value)throw new Error('No "value" specified.');break;case"scatter":}}function i(){var t=["#1ABC9C","#E74C3C","#9B59B6","#3498DB","#F1C40F","#D35400","#2ECC71","#E67E22","#2C3E50","#C0392B"],e=["#28E1BC","#ED7469","#B07CC6","#5FAEE3","#F4D03F","#FF6607","#54D98B","#EB9850","#3E5771","#D65448"],a={styles:{fillColor:"#DDDDDD",fillOpacity:.3,outerStrokeColor:"#000000",outerStrokeWidth:2,innerStrokeColor:"#000000",innerStrokeWidth:1,size:{width:500,height:300},axes:{x:{ticks:{fillColor:"#000000",fontSize:"14px"},label:{fillColor:"#000000",fontSize:"14px"}},y:{ticks:{fillColor:"#000000",fontSize:"14px"},label:{fillColor:"#000000",fontSize:"14px"}}},series:{strokeWidth:2,strokeColors:t,fillColors:["none","none","none","none","none","none","none","none","none","none","none"]},markers:{size:3.5,strokeWidth:2,style:"default",strokeColors:t,fillColors:e}},xCoord:{label:""},yCoord:{label:""},marker:{label:"label",latitude:"latitude",longitude:"longitude",magnitude:"radius"}};return a}function n(t,e){for(var a in e)"object"==typeof e[a]?(t[a]=t[a]?t[a]:{},n(t[a],e[a])):t[a]=t[a]?t[a]:e[a]}this.graph=function(l,o,d){t(d),n(d,i());var c;switch(d.type){case"line":case"scatter":case"bar":c=new a(d,l);break;case"map":c=new r(d,l);break;case"table":c=new s(d,l);break;default:throw new Error("Invalid config type: "+d.type)}c.init();var f=new e(o,d,c),u=[{path:"/",params:{}}];f.parsePath(u,0)}},e=function(t,e,i){function n(t,e){c.child(t.path).on(e,function(e){var a,r,s=e.val();switch(f.type){case"map":r={path:t.path+e.name(),label:s[f.marker.label],radius:s[f.marker.magnitude],latitude:parseFloat(s[f.marker.latitude]),longitude:parseFloat(s[f.marker.longitude])};break;case"table":r=[],f.columns.forEach(function(t){r.push("undefined"!=typeof s[t.value]?s[t.value].toString():"")});break;case"bar":a="$"===f.series[0]?t.params[f.series]:s[f.series],r={path:t.path+e.name(),series:a,value:parseInt(s[f.value])};break;case"line":case"scatter":a="$"===f.series[0]?t.params[f.series]:s[f.series];var i;i="undefined"!=typeof f.xCoord.stream&&f.xCoord.stream?p.data[a]?p.data[a].streamCount:0:parseInt(s[f.xCoord.value]),r={series:a,path:t.path+e.name(),xCoord:i,yCoord:parseInt(s[f.yCoord.value])}}p.addDataPoint(r)})}function l(t){switch(f.type){case"bar":case"line":case"scatter":delete p.data[t]}p.draw()}function o(t){switch(f.type){case"map":c.child(t.path).on("child_removed",function(e){p.data.forEach(function(a,r){a.path===t.path+e.name()&&p.data.splice(r,1)})});break;case"table":break;case"bar":case"line":case"scatter":c.child(t.path).on("child_removed",function(e){var a="$"===f.series[0]?t.params[f.series]:e.val()[f.series];p.data[a].values.forEach(function(r,s){if(r.path===t.path+e.name()){var i=p.data[a].values.splice(s,1);"bar"===f.type&&(p.data[a].sum-=i)}})})}p.draw()}function d(){}if(this.parsePath=function(t,e){if(e===u.length){var a="*"===u[u.length-1]?"child_added":"value";t.forEach(function(t){n(t,a),"child_added"===a&&(o(t),d(t))})}else{var r=u[e];if("*"===r[0]){if(e!==u.length-1)throw new Error('You can only use * as the last character in your "path"');this.parsePath(t,e+1)}else if("$"===r[0])t.forEach(function(t){c.child(t.path).on("child_added",function(a){var s={path:t.path+a.name()+"/",params:{}};s.params[r]=a.name();for(var i in t.params)t.params.hasOwnnKey(i)&&(s.params[i]=t.params);this.parsePath([s],e+1)}.bind(this)),c.child(t.path).on("child_removed",function(t){l(t.name())})}.bind(this));else{var s=[];t.forEach(function(t){s.push({path:t.path+r+"/",params:t.params})}),this.parsePath(s,e+1)}}},t instanceof Firebase==!1)throw new Error("firebaseRef must be an instance of Firebase");var c=t,f=e,u=f.path.split("/");if(i instanceof a==!1&&i instanceof s==!1&&i instanceof r==!1)throw new Error("d3Grapher must be an instance of FireGrapherD3");var p=i},a=function(t,e){function a(t){var e=!1;"undefined"==typeof m.data[t.series]&&(e=!0,g+=1,m.data[t.series]={seriesIndex:g,values:[],aggregation:0},f.domain(Object.keys(m.data))),m.data[t.series].values.push(t.value);var a="median",r=0;switch(a){case"mean":for(var i=0;r<m.data[t.series].values.length;r++)i+=m.data[t.series].values[r];m.data[t.series].aggregation=i/m.data[t.series].values.length;break;case"median":var n=m.data[t.series].values.slice(0);n.sort(function(t,e){return t-e}),m.data[t.series].aggregation=n[Math.ceil(n.length/2)];break;case"min":for(m.data[t.series].aggregation=Number.MAX_VALUE;r<m.data[t.series].values.length;r++)m.data[t.series].values[r]<m.data[t.series].aggregation&&(m.data[t.series].aggregation=m.data[t.series].values[r]);break;case"max":for(m.data[t.series].aggregation=Number.MIN_VALUE;r<m.data[t.series].values.length;r++)m.data[t.series].values[r]>m.data[t.series].aggregation&&(m.data[t.series].aggregation=m.data[t.series].values[r]);break;case"sum":m.data[t.series].aggregation+=t.value;break;default:m.data[t.series].aggregation+=t.value}m.data[t.series].aggregation=m.data[t.series].aggregation?m.data[t.series].aggregation:0,e=e||s(null,[0,m.data[t.series].aggregation]),e?d():o(t.series,m.data[t.series])}function r(t){"undefined"==typeof m.data[t.series]&&(m.data[t.series]={seriesIndex:g,streamCount:0,values:[]},g+=1),m.data[t.series].streamCount+=1;var e=m.data[t.series].values;e.push(t),e.length>1&&t.xCoord<=e[e.length-2].xCoord&&e.sort(function(t,e){return e.xCoord-t.xCoord});var a=s(d3.extent(e,function(t){return t.xCoord}),d3.extent(e,function(t){return t.yCoord}));if(y.xCoord.limit&&e.length>y.xCoord.limit&&(e.shift(),f.domain(d3.extent(e,function(t){return t.xCoord})),a=!0),a)d();else{var r=m.data[t.series].seriesIndex;switch(i(),y.type){case"line":n(r,e),l(r,e);break;case"scatter":l(r,e)}}}function s(t,e){var a=!1,r=!1;if(t&&t[0]<p.min&&(p.min=t[0],a=!0),t&&t[1]>p.max&&(p.max=t[1],a=!0),e&&e[0]<h.min&&(h.min=e[0],r=!0),e&&e[1]>h.max&&(h.max=e[1],r=!0),a&&f.domain([p.min,p.max]),r){var s=.1*(h.max-h.min);u.domain([h.min-s,h.max+s])}return a||r}function i(){var t=[];for(var e in m.data)"undefined"!==e&&t.push(e);if(c.selectAll("g.fg-legend").remove(),t.length>1){var a={top:5,bottom:5,left:5,right:5},r=50,s=20*t.length,i=y.styles.size.width-2*r-a.left-a.right,n=y.styles.size.height-2*s-a.top-a.bottom,l=c.append("g").attr("class","fg-legend");l.append("rect").attr("class","fg-legend-container").attr("x",i).attr("y",n).attr("width",r+a.left+a.right).attr("height",s+a.top+a.bottom).style("stroke","red").style("fill","black"),l.selectAll("text").data(t).enter().append("text").attr("class",function(t,e){return"fg-legend-series fg-series-"+e}).attr("x",i).attr("y",n).attr("dx",r).attr("dy",function(t,e){return 20*(e+1)}).style("text-anchor","end").style("stroke",function(t,e){return y.styles.series.strokeColors[e]}).text(function(t){return t})}}function n(t,e){var a=d3.svg.line().defined(function(t){return null!==t}).x(function(t){return f(t.xCoord)}).y(function(t){return u(t.yCoord)}).interpolate("linear");0===c.selectAll("path.fg-series-"+t)[0].length&&c.append("path").attr("class","fg-series fg-series-"+t),c.select("path.fg-series-"+t).data([e]).attr("class","fg-series fg-series-"+t).attr("stroke",y.styles.series.strokeColors[t]).attr("stroke-width",y.styles.series.strokeWidth).attr("fill",y.styles.series.fillColors[t]).attr("d",a(e))}function l(t,e){c.selectAll("circle.fg-series"+t).data(e).enter().append("circle").attr("class","fg-marker fg-series-"+t).attr("stroke",y.styles.markers.strokeColors[t]).attr("stroke-width",y.styles.markers.strokeWidth).attr("fill",y.styles.markers.fillColors[t]).attr("cx",function(t){return f(t.xCoord)}).attr("cy",function(t){return u(t.yCoord)}).attr("r",y.styles.markers.size)}function o(t,e){var a=e.seriesIndex;c.selectAll(".fg-bar .fg-series"+a).data([e]).enter().append("rect").attr("class","fg-series fg-series-"+a).attr("value",function(t){return t.aggregation}).attr("x",function(){return f(t)}).attr("width",f.rangeBand()).attr("y",function(t){return u(t.aggregation)}).attr("height",function(t){return u.range()[0]-u(t.aggregation)})}function d(){var t={top:20,bottom:30,left:60,right:20},e=y.styles.size.height-t.bottom-t.top,a=y.styles.size.width-t.left-t.right;d3.select(x+" svg").remove(),c=d3.select(x).append("svg").attr("class","fg-"+y.type).attr("width",y.styles.size.width+t.left+t.right).attr("height",y.styles.size.height+t.bottom+t.top).append("g").attr("transform","translate("+t.left+", "+t.bottom+")"),y.title&&c.append("text").attr("class","fg-title").attr("x",a/2).attr("y",0-t.top/2).attr("text-anchor","middle").style("font-size","16px").style("text-decoration","underline").text(y.title),u.range([e,0]),"bar"===y.type?f.rangeRoundBands([0,a],.1,1):f.range([0,a]);var r=d3.svg.axis().orient("bottom").scale(f).ticks(Math.floor(.035*a)).tickSize(-e,-e),s=d3.svg.axis().orient("left").scale(u).ticks(Math.floor(.035*e)).tickSize(-a,-a);c.append("g").attr("class","fg-axis fg-x-axis").attr("transform","translate(0,"+e+")").call(r).selectAll("text").attr("x",0).attr("y",10),c.append("g").attr("class","fg-axis fg-y-axis").call(s).selectAll("text").attr("x",-10).attr("y",0),c.selectAll(".domain").attr("stroke",y.styles.outerStrokeColor).attr("stroke-width",y.styles.outerStrokeWidth).attr("fill",y.styles.fillColor).attr("fill-opacity",y.styles.fillOpacity),c.selectAll(".fg-x-axis .tick").attr("stroke",y.styles.innerStrokeColor).attr("stroke-width","bar"===y.type?0:y.styles.innerStrokeWidth),c.selectAll(".fg-y-axis .tick").attr("stroke",y.styles.innerStrokeColor).attr("stroke-width",y.styles.innerStrokeWidth),c.selectAll(".fg-x-axis text").attr("stroke","none").attr("fill",y.styles.axes.x.ticks.fillColor).attr("font-size",y.styles.axes.x.ticks.fontSize),c.selectAll(".fg-y-axis text").attr("stroke","none").attr("fill",y.styles.axes.y.ticks.fillColor).attr("font-size",y.styles.axes.y.ticks.fontSize),c.append("text").attr("class","fg-axis-label fg-x-axis-label").attr("transform","translate(0, 50)").attr("fill",y.styles.axes.x.label.fillColor).attr("font-size",y.styles.axes.x.label.fontSize).attr("font-weight","bold").attr("dx",a).attr("dy",e).style("text-anchor","end").text(y.xCoord.label),c.append("text").attr("class","fg-axis-label fg-y-axis-label").attr("transform","rotate(-90)").attr("fill",y.styles.axes.y.label.fillColor).attr("font-size",y.styles.axes.y.label.fontSize).attr("font-weight","bold").attr("dy",-t.left+16).style("text-anchor","end").text(y.yCoord.label);for(var d in m.data)if(m.data.hasOwnProperty(d)){var p=m.data[d].seriesIndex,h=m.data[d].values;switch(y.type){case"line":i(),n(p,h),l(p,h);break;case"scatter":i(),l(p,h);break;case"bar":o(d,m.data[d])}}}var c,f,u,p,h,g,y=t,x=e,m=this;this.init=function(){this.data={},p={min:Number.MAX_VALUE/2,max:Number.MIN_VALUE/2},h={min:Number.MAX_VALUE/2,max:Number.MIN_VALUE/2},g=0,f="bar"===y.type?d3.scale.ordinal():d3.scale.linear().domain([p.min,p.max]),f.range([0,y.styles.size.width]),u=d3.scale.linear().domain([h.min,h.max]).range([y.styles.size.height,0])},this.draw=function(){var t={top:20,bottom:30,left:60,right:20},e=y.styles.size.height-t.bottom-t.top,a=y.styles.size.width-t.left-t.right;d3.select(x+" svg").remove(),c=d3.select(x).append("svg").attr("class","fg-"+y.type).attr("width",y.styles.size.width+t.left+t.right).attr("height",y.styles.size.height+t.bottom+t.top).append("g").attr("transform","translate("+t.left+", "+t.bottom+")"),y.title&&c.append("text").attr("class","fg-title").attr("x",a/2).attr("y",0-t.top/2).attr("text-anchor","middle").style("font-size","16px").style("text-decoration","underline").text(y.title),u.range([e,0]),"bar"===y.type?f.rangeRoundBands([0,a],.1,1):f.range([0,a]);var r=d3.svg.axis().orient("bottom").scale(f).ticks(Math.floor(.035*a)).tickSize(-e,-e),s=d3.svg.axis().orient("left").scale(u).ticks(Math.floor(.035*e)).tickSize(-a,-a);c.append("g").attr("class","fg-axis fg-x-axis").attr("transform","translate(0,"+e+")").call(r).selectAll("text").attr("x",0).attr("y",10),c.append("g").attr("class","fg-axis fg-y-axis").call(s).selectAll("text").attr("x",-10).attr("y",0),c.selectAll(".domain").attr("stroke",y.styles.outerStrokeColor).attr("stroke-width",y.styles.outerStrokeWidth).attr("fill",y.styles.fillColor).attr("fill-opacity",y.styles.fillOpacity),c.selectAll(".fg-x-axis .tick").attr("stroke",y.styles.innerStrokeColor).attr("stroke-width","bar"===y.type?0:y.styles.innerStrokeWidth),c.selectAll(".fg-y-axis .tick").attr("stroke",y.styles.innerStrokeColor).attr("stroke-width",y.styles.innerStrokeWidth),c.selectAll(".fg-x-axis text").attr("stroke","none").attr("fill",y.styles.axes.x.ticks.fillColor).attr("font-size",y.styles.axes.x.ticks.fontSize),c.selectAll(".fg-y-axis text").attr("stroke","none").attr("fill",y.styles.axes.y.ticks.fillColor).attr("font-size",y.styles.axes.y.ticks.fontSize),c.append("text").attr("class","fg-axis-label fg-x-axis-label").attr("transform","translate(0, 50)").attr("fill",y.styles.axes.x.label.fillColor).attr("font-size",y.styles.axes.x.label.fontSize).attr("font-weight","bold").attr("dx",a).attr("dy",e).style("text-anchor","end").text(y.xCoord.label),c.append("text").attr("class","fg-axis-label fg-y-axis-label").attr("transform","rotate(-90)").attr("fill",y.styles.axes.y.label.fillColor).attr("font-size",y.styles.axes.y.label.fontSize).attr("font-weight","bold").attr("dy",-t.left+16).style("text-anchor","end").text(y.yCoord.label);for(var d in m.data)if(m.data.hasOwnProperty(d)){var p=m.data[d].seriesIndex,h=m.data[d].values;switch(y.type){case"line":i(),n(p,h),l(p,h);break;case"scatter":i(),l(p,h);break;case"bar":o(d,m.data[d])}}},this.addDataPoint=function(t){switch(y.type){case"bar":a(t);break;case"line":case"scatter":r(t)}}},r=function(t,e){var a,r=e,s=this;this.init=function(){this.data=[];var t=new google.maps.Map(d3.select(r).node(),{zoom:8,center:new google.maps.LatLng(37.76487,-122.41948),mapTypeId:google.maps.MapTypeId.TERRAIN});a=new google.maps.OverlayView,a.onAdd=function(){function t(t){return t=new google.maps.LatLng(t.latitude,t.longitude),t=r.fromLatLngToDivPixel(t),d3.select(s).style("left",t.x-i+"px").style("top",t.y-i+"px")}var e=d3.select(a.getPanes().overlayLayer).append("div").attr("class","stations"),r=a.getProjection(),i=10;a.draw=function(){if(0!==s.data.length){var a=e.selectAll("svg").data(s.data).each(t).enter().append("svg:svg").each(t).attr("class","marker");a.append("svg:circle").attr("r",function(t){return t.radius}).attr("cx",function(t){return t.radius+i}).attr("cy",function(t){return t.radius+i}),a.append("svg:text").attr("x",i+7).attr("y",i).attr("dy",".31em").text(function(t){return t.label})}else e.selectAll("svg").remove()}},a.setMap(t)},this.draw=function(){a.draw()},this.addDataPoint=function(t){s.data.push(t),s.drawMap()}},s=function(t,e){function a(t){var e=0,a=!0;r.append("div").attr("class","row head clearfix").selectAll("div.header").data(t).enter().append("div").attr("class","header").attr("width",function(t){return t.width}).text(function(t){return t.label}).on("click",function(s){for(var i=0,n=0;n<t.length;n++)t[n]===s&&(i=n);e!==i?(e=i,a=!0):a=!a,r.selectAll("div.data").sort(function(t,r){return t[e]===r[e]?0:a?t[e]>r[e]:t[e]<r[e]})})}var r,s=t,i=e,n=this;this.init=function(){this.data=[],r=d3.select(i).append("div").attr("class","table"),a(s.columns)},this.draw=function(){},this.addDataPoint=function(t){n.data.push(t),r.selectAll("div.row").data(n.data).enter().append("div").attr("class","row data clearfix").selectAll("div.cell").data(function(t){return t}).enter().append("div").attr("class","cell").attr("width",function(t,e){return s.columns[e].width}).text(function(t){return t})}};return t}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=FireGrapher);