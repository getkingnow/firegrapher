var FireGrapher=function(){"use strict";return FireGrapher=function(){},FireGrapher.prototype.graph=function(t,i,e){this.cssSelector=t,this.firebaseRef=i,this.validateConfig(e),this.config=e,this.setDefaultConfig(),this.draw(),this.pathNodes=e.path.split("/"),this.parsePath(["/"],0)},FireGrapher.prototype.setDefaultConfig=function(){switch(this.config.type){case"line":case"scatter":this.config.graph=this.config.graph?this.config.graph:{},this.config.graph.width=this.config.graph.width?this.config.graph.width:500,this.config.graph.height=this.config.graph.height?this.config.graph.height:300,this.config.xCoord.min=this.config.xCoord.min?this.config.xCoord.min:0,this.config.xCoord.max=this.config.xCoord.max?this.config.xCoord.max:50,this.config.yCoord.min=this.config.yCoord.min?this.config.yCoord.min:0,this.config.yCoord.max=this.config.yCoord.max?this.config.yCoord.max:200}},FireGrapher.prototype.validateConfig=function(t){var i=["table","line","scatter"];if("undefined"==typeof t.type)throw new Error('No graph "type" specified. Must be "table", "line", or "scatter"');if(-1===i.indexOf(t.type))throw new Error('Invalid graph "type" specified. Must be "table", "line", or "scatter"');if("undefined"==typeof t.path)throw new Error('No "path" to individual record specified.');switch(t.type){case"table":if("undefined"==typeof t.columns)throw new Error('No table "columns" specified.');t.columns.forEach(function(t){if("undefined"==typeof t.label)throw new Error('Missing "columns" label.');if("undefined"==typeof t.value)throw new Error('Missing "columns" value.')});break;case"line":if("undefined"==typeof t.xCoord)throw new Error('No "xCoord" specified.');if("undefined"==typeof t.yCoord)throw new Error('No "yCoord" specified.');break;case"scatter":}},FireGrapher.prototype.parsePath=function(t,i){if(i===this.pathNodes.length){var e="*"===this.pathNodes[this.pathNodes.length-1]?"child_added":"value";t.forEach(function(t){this.listenForNewRecords(t,e),"child_added"===e&&this.listenForRemovedRecords(t)}.bind(this))}else{var a=this.pathNodes[i];if("*"===a[0]){if(i!==this.pathNodes.length-1)throw new Error('You can only use * as the last character in your "path"');this.parsePath(t,i+1)}else t.forEach("$"===a[0]?function(t){this.firebaseRef.child(t).on("child_added",function(e){this.parsePath([t+e.name()+"/"],i+1)}.bind(this))}.bind(this):function(t){this.parsePath([t+=a+"/"],i+1)}.bind(this))}},FireGrapher.prototype.listenForNewRecords=function(t,i){var e=t.split("/"),a=e[e.length-2];switch(this.config.type){case"table":this.firebaseRef.child(t).on(i,function(i){var e=i.val(),a=[];this.config.columns.forEach(function(t){a.push("undefined"!=typeof e[t.value]?e[t.value].toString():"")}),a.path=t+i.name(),this.addDataPointToTable(a)}.bind(this));break;case"line":case"scatter":this.firebaseRef.child(t).on(i,function(i){var e,r=i.val(),s="$"===this.config.line[0]?a:r[this.config.line];e="undefined"!=typeof this.config.xCoord.stream&&this.config.xCoord.stream?this.graphData[s]&&this.graphData[s].streamCount?this.graphData[s].streamCount:0:parseInt(r[this.config.xCoord.value]),this.addDataPointToGraph({series:s,path:t+i.name(),xCoord:e,yCoord:parseInt(r[this.config.yCoord.value])})}.bind(this))}},FireGrapher.prototype.listenForRemovedRecords=function(t){var i=t.split("/"),e=i[i.length-2];switch(this.config.type){case"table":console.log("TABLE");break;case"line":case"scatter":this.firebaseRef.child(t).on("child_removed",function(i){var a=i.val(),r="$"===this.config.line[0]?e:a[this.config.line];this.graphData[r].coordinates.forEach(function(e,a){e.path===t+i.name()&&this.graphData[r].coordinates.splice(a,1)}.bind(this)),this.drawScales()}.bind(this))}},FireGrapher.prototype.addHeaders=function(t){this.sortColumn=0,this.sortAsc=!0,this.table.append("div").attr("class","row head clearfix").selectAll("div.header").data(t).enter().append("div").attr("class","header").attr("width",function(t){return t.width}).text(function(t){return t.label}).on("click",function(i){for(var e=0,a=0;a<t.length;a++)t[a]===i&&(e=a);this.sortColumn!==e?(this.sortColumn=e,this.sortAsc=!0):this.sortAsc=!this.sortAsc,this.table.selectAll("div.data").sort(function(t,i){return t[this.sortColumn]===i[this.sortColumn]?0:this.sortAsc?t[this.sortColumn]>i[this.sortColumn]:t[this.sortColumn]<i[this.sortColumn]}.bind(this))}.bind(this))},FireGrapher.prototype.addDataPointToTable=function(t){this.tableRows.push(t),this.table.selectAll("div.row").data(this.tableRows).enter().append("div").attr("class","row data clearfix").selectAll("div.cell").data(function(t){return t}).enter().append("div").attr("class","cell").attr("width",function(t,i){return this.config.columns[i].width}.bind(this)).text(function(t){return t})},FireGrapher.prototype.changeScales=function(t,i){var e=!1,a=!1;if(t[0]<this.xScale.domain()[0]&&(this.xScale.domain([t[0],this.xScale.domain()[1]]),e=!0),t[1]>this.xScale.domain()[1]&&(this.xScale.domain([this.xScale.domain()[0],t[1]]),e=!0),i[0]<this.yScale.domain()[0]&&(this.yScale.domain([i[0],this.yScale.domain()[1]]),a=!0),i[1]>this.yScale.domain()[1]&&(this.yScale.domain([this.yScale.domain()[0],i[1]]),a=!0),a){var r=this.yScale.domain(),s=.1*(r[1]-r[0]);this.yScale.domain([r[0]-s,r[1]+s])}return e||a},FireGrapher.prototype.addDataPointToGraph=function(t){"undefined"==typeof this.graphData[t.series]&&(this.numSeries+=1,this.graphData[t.series]={seriesIndex:this.numSeries,streamCount:0,coordinates:[]}),this.graphData[t.series].streamCount+=1;var i=this.graphData[t.series].coordinates;i.push(t),i.length>1&&t.xCoord<=i[i.length-2].xCoord&&i.sort(function(t,i){return i.xCoord-t.xCoord});var e=this.changeScales(d3.extent(i,function(t){return t.xCoord}),d3.extent(i,function(t){return t.yCoord}));if(this.config.xCoord.limit&&i.length>this.config.xCoord.limit&&(i.shift(),this.xScale.domain(d3.extent(i,function(t){return t.xCoord})),e=!0),e)this.drawScales();else switch(this.config.type){case"line":var a=this.graphData[t.series].seriesIndex;this.drawLine(a,i),this.drawDataPoints(a,i);break;case"scatter":this.drawDataPoints(this.graphData[t.series].seriesIndex,i)}},FireGrapher.prototype.drawLine=function(t,i){var e=d3.svg.line().defined(function(t){return null!==t}).x(function(t){return this.xScale(t.xCoord)}.bind(this)).y(function(t){return this.yScale(t.yCoord)}.bind(this)).interpolate("linear");0===this.graph.selectAll("path.series"+t)[0].length&&this.graph.append("path").attr("class","series series"+t),this.graph.select("path.series"+t).data([i]).attr("d",e(i))},FireGrapher.prototype.drawDataPoints=function(t,i){this.graph.selectAll("circle.series"+t).data(i).enter().append("circle").attr("class","dataPoint series"+t).attr("cx",function(t){return this.xScale(t.xCoord)}.bind(this)).attr("cy",function(t){return this.yScale(t.yCoord)}.bind(this)).attr("r",3.5)},FireGrapher.prototype.drawScales=function(){var t=50,i=20;d3.select(this.cssSelector+" svg").remove(),this.graph=d3.select(this.cssSelector).append("svg").attr("class",this.config.type).append("g").attr("transform","translate("+t+", "+i+")");var e=d3.svg.axis().scale(this.xScale).tickPadding(100).tickSize(-this.config.graph.height,-this.config.graph.height,-50),a=d3.svg.axis().orient("left").scale(this.yScale).tickSize(-this.config.graph.width,-this.config.graph.width,-50);this.graph.append("g").attr("class","x axis").attr("transform","translate(0,"+this.config.graph.height+")").call(e).selectAll("text").attr("x",0).attr("y",5),this.graph.append("g").attr("class","y axis").call(a).selectAll("text").attr("x",-10).attr("y",0),this.graph.append("text").attr("transform","translate(0, 50)").attr("dx",this.config.graph.width).attr("dy",this.config.graph.height).style("text-anchor","end").text("X LABEL"),this.graph.append("text").attr("transform","rotate(-90)").attr("dy",-35).style("text-anchor","end").text("Y LABEL");for(var r in this.graphData)if(this.graphData.hasOwnProperty(r)){var s=this.graphData[r].seriesIndex,o=this.graphData[r].coordinates;switch(this.config.type){case"line":this.drawLine(s,o),this.drawDataPoints(s,o);break;case"scatter":this.drawDataPoints(s,o)}}},FireGrapher.prototype.draw=function(){switch(this.config.type){case"table":this.tableRows=[],this.table=d3.select(this.cssSelector).append("div").attr("class","table"),this.addHeaders(this.config.columns);break;case"line":case"scatter":this.graphData={},this.numSeries=0,this.xScale=d3.scale.linear().domain([1e6,-1e6]).range([0,this.config.graph.width]),this.yScale=d3.scale.linear().domain([1e6,-1e6]).range([this.config.graph.height,0])}},FireGrapher}();"undefined"!=typeof module&&(module.exports=FireGrapher);